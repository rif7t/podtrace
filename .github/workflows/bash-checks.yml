name: Bash Script Checks

on:
  push:
    branches: ["**"]
    paths:
      - "**/*.sh"
      - "scripts/**"
      - "build.sh"
      - "test/**/*.sh"
  pull_request:
    branches: ["**"]
    paths:
      - "**/*.sh"
      - "scripts/**"
      - "build.sh"
      - "test/**/*.sh"

jobs:
  bash-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            shellcheck \
            devscripts \
            shfmt \
            python3-pip
          pip3 install bashate || echo "bashate installation failed, will skip bashate checks"

      - name: Syntax Check
        run: |
          echo "Running bash syntax check..."
          for file in $(git ls-files '*.sh'); do
            echo "â†’ Checking syntax: $file"
            bash -n "$file"
          done

      - name: Run ShellCheck
        run: |
          echo "Running strict ShellCheck..."
          shellcheck --enable=all -x $(git ls-files '*.sh')

      - name: Check for bashisms
        run: |
          echo "Checking for bashisms..."
          checkbashisms $(git ls-files '*.sh')

      - name: Run bashate
        run: |
          echo "Running bashate..."
          if command -v bashate >/dev/null 2>&1; then
            bashate $(git ls-files '*.sh') || echo "bashate check completed with warnings"
          else
            echo "bashate not available, skipping..."
          fi

      - name: Check formatting (shfmt)
        run: |
          echo "Checking formatting with shfmt..."
          shfmt -d . || {
            echo "Formatting issues found. To fix, run: shfmt -w ."
            echo "Or the workflow can auto-fix by running: shfmt -w ."
            exit 1
          }
